use crate::koala::CredentialsType;
use crate::routes::appdata::WebData;
use crate::routes::error::{Error, WebResult};
use crate::routes::redirect::Redirect;
use actix_web::web;
use dal::database::{OAuthAccess, User};
use serde::Deserialize;
use tracing::trace;

#[derive(Debug, Deserialize)]
pub struct Query {
    /// The OAuth code generated by Koala
    code: String,
}

/// Complete the Koala login flow.
/// The provided code must be generated by Koala.
///
/// Creates a session for the requesting user.
///
/// # Errors
///
/// - If the provided `code` isn't valid
/// - If something went wrong
pub async fn login(data: WebData, query: web::Query<Query>) -> WebResult<Redirect> {
    // Complete the OAuth2 flow by exchanging the code for a token pair
    trace!("Exchanging received code for Oauth2 tokens with Koala");
    let oauth_tokens = crate::koala::exchange_code(&data.config, &query.code)
        .await
        .map_err(|e| Error::Koala(e))?;

    let is_admin = oauth_tokens.credentials_type == CredentialsType::Admin;
    trace!("Is signed-in user admin?: {is_admin}");

    let created_at_epoch =
        chrono::DateTime::parse_from_rfc3339(&oauth_tokens.created_at)?.timestamp();
    let expires_at = created_at_epoch - oauth_tokens.expires_in;
    let user = match User::get_by_id(&data.db, oauth_tokens.credentials_id).await? {
        Some(mut u) => {
            trace!("User already exists in database, setting new OAuth2 tokens");

            // Update the tokens for this user
            u.set_tokens(
                oauth_tokens.access_token,
                oauth_tokens.refresh_token,
                expires_at,
            )
            .await?;
            u
        }
        // No user exists yet, create one
        None => {
            trace!("User does not yet exist in database, creating new user.");

            User::create(
                &data.db,
                oauth_tokens.credentials_id,
                OAuthAccess {
                    access_token: oauth_tokens.access_token,
                    refresh_token: oauth_tokens.refresh_token,
                    expires_at,
                },
                is_admin,
            )
            .await?
        }
    };

    trace!("Creating new session for user.");
    let session_id = user.create_session().await?;
    let redirect_to = format!(
        "{}?session_id={}&is_admin={}",
        data.config.login_complete_redirect_uri, session_id, is_admin
    );
    Ok(Redirect::new(redirect_to))
}
